<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flexible Influencer Data Collector (Input Only)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .container-card {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #10b981; /* Tailwind emerald-500 */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .header-bg {
            background-color: #065f46; /* Dark Green */
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex flex-col items-center">

    <!-- Main Container -->
    <div class="w-full max-w-5xl bg-white container-card rounded-xl">
        
        <!-- Header -->
        <div class="header-bg text-white p-6 rounded-t-xl">
            <h1 class="text-3xl font-extrabold mb-1">Flexible Influencer Scout (Input Only)</h1>
            <p class="text-sm font-light">Securely save channel data to your private database.</p>
            <div id="authStatus" class="text-xs mt-2 p-1 bg-emerald-700 rounded w-fit">
                Authenticating...
            </div>
        </div>

        <!-- Main Content: Data Input Form (Now centered and full width) -->
        <div class="p-6">
            
            <!-- Data Input Form Container -->
            <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 max-w-2xl mx-auto">
                <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Add New Influencer</h2>
                
                <form id="influencerForm" class="space-y-4">
                    
                    <!-- Channel Name -->
                    <div>
                        <label for="channelName" class="block text-sm font-medium text-gray-700">Channel/Page Name <span class="text-red-500">*</span></label>
                        <input type="text" id="channelName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 p-2.5">
                    </div>

                    <!-- Channel Link -->
                    <div>
                        <label for="channelLink" class="block text-sm font-medium text-gray-700">Channel/Page Link üîó <span class="text-red-500">*</span></label>
                        <input type="url" id="channelLink" required placeholder="e.g., https://youtube.com/@channelname" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 p-2.5">
                    </div>

                    <!-- Channel Type (Select + Other Input) -->
                    <div>
                        <label for="channelType" class="block text-sm font-medium text-gray-700">Channel Type <span class="text-red-500">*</span></label>
                        <select id="channelType" required onchange="handleOtherType()" class="mt-1 block w-full pl-3 pr-10 py-2.5 text-base border-gray-300 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 rounded-md shadow-sm transition">
                            <option value="" disabled selected>Select a category</option>
                            <option value="Gym/Fitness">üèãÔ∏è Gym/Fitness</option>
                            <option value="Gaming/Esports">üéÆ Gaming/Esports</option>
                            <option value="Cooking/Food">üç≥ Cooking/Food</option>
                            <option value="Technology/AI">ü§ñ Technology/AI</option>
                            <option value="Travel/Vlog">‚úàÔ∏è Travel/Vlog</option>
                            <option value="Finance/Investing">üìà Finance/Investing</option>
                            <option value="Beauty/Fashion">üíÖ Beauty/Fashion</option>
                            <option value="DIY/Crafts">üõ†Ô∏è DIY/Crafts</option>
                            <option value="Education/Science">üî¨ Education/Science</option>
                            <option value="Other">... Other (Specify below)</option>
                        </select>
                        <input type="text" id="otherChannelType" placeholder="Specify your custom type" class="mt-2 hidden w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 p-2.5" disabled>
                    </div>

                    <!-- Followers (Free Text Input) -->
                    <div>
                        <label for="followers" class="block text-sm font-medium text-gray-700">Followers/Subscribers (e.g., 120K, 1M, 500k) <span class="text-red-500">*</span></label>
                        <input type="text" id="followers" required placeholder="e.g., 500K or 1.2M" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 p-2.5">
                    </div>

                    <!-- Country -->
                    <div>
                        <label for="country" class="block text-sm font-medium text-gray-700">Country <span class="text-red-500">*</span></label>
                        <select id="country" required class="mt-1 block w-full pl-3 pr-10 py-2.5 text-base border-gray-300 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 rounded-md shadow-sm transition">
                            <!-- Options populated by JS -->
                        </select>
                    </div>

                    <!-- Minimum Charges (Dynamic Currency) -->
                    <div>
                        <label for="minCharge" class="block text-sm font-medium text-gray-700">Minimum Charge (Per Post/Campaign)</label>
                        <div class="mt-1 relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span id="currencySymbol" class="text-gray-500 sm:text-sm">$</span>
                            </div>
                            <input type="number" id="minCharge" placeholder="Optional" min="0" step="1" class="block w-full pl-7 pr-3 py-2.5 rounded-md border-gray-300 focus:border-emerald-500 focus:ring-emerald-500">
                        </div>
                    </div>

                    <!-- Phone Number -->
                    <div>
                        <label for="phoneNumber" class="block text-sm font-medium text-gray-700">Phone Number (Optional)</label>
                        <input type="tel" id="phoneNumber" placeholder="+X (XXX) XXX-XXXX" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 p-2.5">
                    </div>
                    
                    <!-- Submit Button -->
                    <button type="submit" id="saveBtn" class="w-full flex items-center justify-center py-3 px-4 border border-transparent rounded-md shadow-md text-base font-semibold text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition duration-150">
                        <span id="buttonText">Save Influencer</span>
                        <div id="loadingSpinner" class="spinner ml-3 hidden"></div>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Messages (Instead of alert() or confirm()) -->
    <div id="messageModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm transform scale-100 transition-transform duration-300">
            <h3 id="modalTitle" class="text-lg font-semibold text-gray-800 mb-3">System Message</h3>
            <p id="modalMessage" class="text-gray-600 mb-4"></p>
            <div class="flex justify-end space-x-2">
                <button id="modalConfirmBtn" onclick="modalCallback(true)" class="hidden py-2 px-4 rounded-md bg-red-600 text-white font-medium hover:bg-red-700 transition">Confirm</button>
                <button id="modalCloseBtn" onclick="modalCallback(false)" class="py-2 px-4 rounded-md bg-emerald-600 text-white font-medium hover:bg-emerald-700 transition">Close</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Imports and Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, setLogLevel, deleteDoc, doc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase/Auth Setup Variables (MANDATORY) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Global Firebase instances
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        // --- UI Elements ---
        const authStatus = document.getElementById('authStatus');
        const influencerForm = document.getElementById('influencerForm');
        const channelTypeSelect = document.getElementById('channelType');
        const otherChannelTypeInput = document.getElementById('otherChannelType');
        const countrySelect = document.getElementById('country');
        const currencySymbolSpan = document.getElementById('currencySymbol');
        const minChargeInput = document.getElementById('minCharge');
        const saveBtn = document.getElementById('saveBtn');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');

        // Modal elements 
        const messageModal = document.getElementById('messageModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        let currentModalResolver = null;

        // --- Core Data: Countries and Currencies ---
        const COUNTRIES_AND_CURRENCIES = [
            { code: "USA", country: "United States", currency: "USD", symbol: "$" },
            { code: "IND", country: "India", currency: "INR", symbol: "‚Çπ" },
            { code: "GBR", country: "United Kingdom", currency: "GBP", symbol: "¬£" },
            { code: "CAN", country: "Canada", currency: "CAD", symbol: "C$" },
            { code: "AUS", country: "Australia", currency: "AUD", symbol: "A$" },
            { code: "EUR", country: "Eurozone (e.g., Germany, France)", currency: "EUR", symbol: "‚Ç¨" },
            { code: "JPN", country: "Japan", currency: "JPY", symbol: "¬•" },
            { code: "CHN", country: "China", currency: "CNY", symbol: "¬•" },
            { code: "BRA", country: "Brazil", currency: "BRL", symbol: "R$" },
            { code: "RUS", country: "Russia", currency: "RUB", symbol: "‚ÇΩ" },
            { code: "KOR", country: "South Korea", currency: "KRW", symbol: "‚Ç©" },
            { code: "SGP", country: "Singapore", currency: "SGD", symbol: "S$" },
            { code: "MEX", country: "Mexico", currency: "MXN", symbol: "Mex$" },
            { code: "ZAF", country: "South Africa", currency: "ZAR", symbol: "R" },
        ];
        
        // Currency fallback for countries not in the list
        const DEFAULT_CURRENCY_SYMBOL = '$';
        const DEFAULT_CURRENCY_CODE = 'USD';


        // --- UI Utilities (Modal functions and Loading) ---

        /** Shows a custom modal (like an alert). */
        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalConfirmBtn.classList.add('hidden');
            modalCloseBtn.textContent = 'Close';
            messageModal.classList.remove('hidden');
            messageModal.classList.add('flex');
            return new Promise(resolve => {
                currentModalResolver = resolve;
            });
        }

        /** Shows a custom modal (like a confirmation dialog). */
        function showConfirm(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalConfirmBtn.classList.remove('hidden');
            modalCloseBtn.textContent = 'Cancel';
            messageModal.classList.remove('hidden');
            messageModal.classList.add('flex');
            return new Promise(resolve => {
                currentModalResolver = resolve;
            });
        }

        /** Callback function for modal buttons. */
        window.modalCallback = function(result) {
            messageModal.classList.add('hidden');
            messageModal.classList.remove('flex');
            if (currentModalResolver) {
                currentModalResolver(result);
                currentModalResolver = null;
            }
        }

        /** Sets the loading state for the save button. */
        function setLoading(isLoading) {
            saveBtn.disabled = isLoading;
            if (isLoading) {
                buttonText.textContent = 'Saving...';
                loadingSpinner.classList.remove('hidden');
            } else {
                buttonText.textContent = 'Save Influencer';
                loadingSpinner.classList.add('hidden');
            }
        }

        /** Toggles the 'Other' channel type input visibility and requirement. */
        window.handleOtherType = function() {
            const isOther = channelTypeSelect.value === 'Other';
            if (isOther) {
                otherChannelTypeInput.classList.remove('hidden');
                otherChannelTypeInput.required = true;
                otherChannelTypeInput.disabled = false;
            } else {
                otherChannelTypeInput.classList.add('hidden');
                otherChannelTypeInput.required = false;
                otherChannelTypeInput.disabled = true;
                otherChannelTypeInput.value = ''; // Clear input when hidden
            }
        }

        /** Populates the country dropdown and sets the initial currency symbol. */
        function populateCountryDropdown() {
            const allCountries = [
                ...COUNTRIES_AND_CURRENCIES,
                { code: "AFG", country: "Afghanistan", currency: "AFN", symbol: "ÿã" },
                { code: "ARG", country: "Argentina", currency: "ARS", symbol: "$" },
                { code: "NGA", country: "Nigeria", currency: "NGN", symbol: "‚Ç¶" },
                { code: "SWE", country: "Sweden", currency: "SEK", symbol: "kr" },
                { code: "PAK", country: "Pakistan", currency: "PKR", symbol: "‚Ç®" },
                // Add more countries for a better user experience
            ];

            countrySelect.innerHTML = '<option value="" disabled selected>Select a country</option>';
            countrySelect.innerHTML += allCountries.map(item => 
                `<option value="${item.code}" data-currency="${item.currency || DEFAULT_CURRENCY_CODE}" data-symbol="${item.symbol || DEFAULT_CURRENCY_SYMBOL}">${item.country}</option>`
            ).join('');
            
            currencySymbolSpan.textContent = DEFAULT_CURRENCY_SYMBOL;
        }

        /** Updates the currency symbol based on the selected country. */
        window.updateCurrencySymbol = function() {
            const selectedOption = countrySelect.options[countrySelect.selectedIndex];
            const countryCode = selectedOption?.value;
            
            const currencyData = COUNTRIES_AND_CURRENCIES.find(c => c.code === countryCode);
            
            let symbol = DEFAULT_CURRENCY_SYMBOL;

            if (currencyData) {
                symbol = currencyData.symbol;
            } 
            
            currencySymbolSpan.textContent = symbol;
        }
        
        countrySelect.addEventListener('change', updateCurrencySymbol);


        // --- Firebase Initialization and Auth ---

        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Debug');

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        authStatus.textContent = `User ID: ${userId}`;
                        authStatus.classList.replace('bg-emerald-700', 'bg-green-700');
                    } else {
                        userId = null;
                        isAuthReady = true;
                        authStatus.textContent = `Signed in Anonymously (No Persistence)`;
                        authStatus.classList.replace('bg-emerald-700', 'bg-red-700');
                    }
                });

            } catch (e) {
                console.error("Firebase initialization failed:", e);
                showModal("Error", `Failed to initialize Firebase: ${e.message}`);
                authStatus.textContent = `Error: Initialization Failed`;
                authStatus.classList.replace('bg-emerald-700', 'bg-red-700');
            }
        }

        // --- Firestore Operations ---

        /** Gets the Firestore collection path for the user's private data. */
        function getCollectionRef() {
            if (!db || !userId) {
                console.error("Database or User ID not ready.");
                return null;
            }
            return collection(db, `artifacts/${appId}/users/${userId}/influencers`);
        }
        
        // UI elements for the list (tableStatus, influencersTableBody) and the 
        // functions to load/delete data (loadInfluencers, renderInfluencers, deleteInfluencer) 
        // have been removed, as the user no longer wants to display the collected data.
        
        // References to form inputs for saving (must be inside saveInfluencer or scope)
        const channelNameInput = document.getElementById('channelName');
        const channelLinkInput = document.getElementById('channelLink'); 
        const followersInput = document.getElementById('followers');
        const phoneNumberInput = document.getElementById('phoneNumber');
        
        /** Saves a new influencer to Firestore. */
        async function saveInfluencer(event) {
            event.preventDefault();
            
            if (!isAuthReady || !userId) {
                showModal("Authentication Required", "Please wait for authentication to complete before saving data.");
                return;
            }

            setLoading(true);

            let finalChannelType = channelTypeSelect.value;
            if (finalChannelType === 'Other') {
                finalChannelType = otherChannelTypeInput.value.trim() || 'Unspecified';
            }

            const selectedOption = countrySelect.options[countrySelect.selectedIndex];
            const countryName = selectedOption.textContent; 
            const countryCode = selectedOption.value;
            
            const currencyData = COUNTRIES_AND_CURRENCIES.find(c => c.code === countryCode);
            const finalCurrency = currencyData ? currencyData.currency : DEFAULT_CURRENCY_CODE;
            
            const minChargeValue = parseFloat(minChargeInput.value);

            const influencerData = {
                channelName: channelNameInput.value.trim(),
                channelLink: channelLinkInput.value.trim(),
                type: finalChannelType,
                followers: followersInput.value.trim(), 
                country: countryName,
                currency: finalCurrency,
                minCharge: isNaN(minChargeValue) ? null : minChargeValue,
                phoneNumber: phoneNumberInput.value.trim() || null,
                timestamp: new Date().toISOString() 
            };

            try {
                await addDoc(getCollectionRef(), influencerData);
                showModal("Success", `Data for "${influencerData.channelName}" has been successfully saved to your private database.`);
                influencerForm.reset();
                window.handleOtherType();
                updateCurrencySymbol();
            } catch (error) {
                console.error("Error adding document: ", error);
                showModal("Save Error", `There was an error saving the influencer data: ${error.message}`);
            } finally {
                setLoading(false);
            }
        }

        // --- Event Listeners and Initial Load ---
        window.onload = () => {
            populateCountryDropdown();
            initializeFirebase();
        };

        influencerForm.addEventListener('submit', saveInfluencer);

    </script>
</body>
</html>


                    <!-- Phone Number -->
                    <div>
                        <label for="phoneNumber" class="block text-sm font-medium text-gray-700">Phone Number (Optional)</label>
                        <input type="tel" id="phoneNumber" placeholder="+X (XXX) XXX-XXXX" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 p-2.5">
                    </div>
                    
                    <!-- Submit Button -->
                    <button type="submit" id="saveBtn" class="w-full flex items-center justify-center py-3 px-4 border border-transparent rounded-md shadow-md text-base font-semibold text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition duration-150">
                        <span id="buttonText">Save Influencer</span>
                        <div id="loadingSpinner" class="spinner ml-3 hidden"></div>
                    </button>
                </form>
            </div>

            <!-- Right Column: Collected Data Table -->
            <div class="lg:col-span-2">
                <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Collected Influencers (Real-time)</h2>
                
                <div class="overflow-x-auto bg-white rounded-lg border border-gray-200 shadow-inner">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Channel</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type / Followers</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Min. Charge</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                            </tr>
                        </thead>
                        <tbody id="influencersTableBody" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="5" class="px-3 py-4 text-center text-sm text-gray-500 italic">
                                    <span id="tableStatus">Loading data...</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Messages (Instead of alert() or confirm()) -->
    <div id="messageModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm transform scale-100 transition-transform duration-300">
            <h3 id="modalTitle" class="text-lg font-semibold text-gray-800 mb-3">System Message</h3>
            <p id="modalMessage" class="text-gray-600 mb-4"></p>
            <div class="flex justify-end space-x-2">
                <button id="modalConfirmBtn" onclick="modalCallback(true)" class="hidden py-2 px-4 rounded-md bg-red-600 text-white font-medium hover:bg-red-700 transition">Confirm</button>
                <button id="modalCloseBtn" onclick="modalCallback(false)" class="py-2 px-4 rounded-md bg-emerald-600 text-white font-medium hover:bg-emerald-700 transition">Close</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, setLogLevel, deleteDoc, doc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase/Auth Setup Variables (MANDATORY) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Global Firebase instances
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        // --- UI Elements ---
        const authStatus = document.getElementById('authStatus');
        const influencerForm = document.getElementById('influencerForm');
        const channelNameInput = document.getElementById('channelName');
        const channelTypeSelect = document.getElementById('channelType');
        const otherChannelTypeInput = document.getElementById('otherChannelType');
        const followersInput = document.getElementById('followers'); // Changed to input
        const countrySelect = document.getElementById('country');
        const currencySymbolSpan = document.getElementById('currencySymbol');
        const minChargeInput = document.getElementById('minCharge');
        const phoneNumberInput = document.getElementById('phoneNumber');
        const saveBtn = document.getElementById('saveBtn');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const influencersTableBody = document.getElementById('influencersTableBody');
        const tableStatus = document.getElementById('tableStatus');

        // Modal elements (unchanged)
        const messageModal = document.getElementById('messageModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        let currentModalResolver = null;

        // --- Core Data: Countries and Currencies (Expanded) ---
        const COUNTRIES_AND_CURRENCIES = [
            { code: "USA", country: "United States", currency: "USD", symbol: "$" },
            { code: "IND", country: "India", currency: "INR", symbol: "‚Çπ" },
            { code: "GBR", country: "United Kingdom", currency: "GBP", symbol: "¬£" },
            { code: "CAN", country: "Canada", currency: "CAD", symbol: "C$" },
            { code: "AUS", country: "Australia", currency: "AUD", symbol: "A$" },
            { code: "EUR", country: "Eurozone (e.g., Germany, France)", currency: "EUR", symbol: "‚Ç¨" },
            { code: "JPN", country: "Japan", currency: "JPY", symbol: "¬•" },
            { code: "CHN", country: "China", currency: "CNY", symbol: "¬•" },
            { code: "BRA", country: "Brazil", currency: "BRL", symbol: "R$" },
            { code: "RUS", country: "Russia", currency: "RUB", symbol: "‚ÇΩ" },
            { code: "KOR", country: "South Korea", currency: "KRW", symbol: "‚Ç©" },
            { code: "SGP", country: "Singapore", currency: "SGD", symbol: "S$" },
            { code: "MEX", country: "Mexico", currency: "MXN", symbol: "Mex$" },
            { code: "ZAF", country: "South Africa", currency: "ZAR", symbol: "R" },
        ];
        
        // Currency fallback for countries not in the list
        const DEFAULT_CURRENCY_SYMBOL = '$';
        const DEFAULT_CURRENCY_CODE = 'USD';


        // --- UI Utilities ---

        /** Shows a custom modal (like an alert). */
        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalConfirmBtn.classList.add('hidden');
            modalCloseBtn.textContent = 'Close';
            messageModal.classList.remove('hidden');
            messageModal.classList.add('flex');
            return new Promise(resolve => {
                currentModalResolver = resolve;
            });
        }

        /** Shows a custom modal (like a confirmation dialog). */
        function showConfirm(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalConfirmBtn.classList.remove('hidden');
            modalCloseBtn.textContent = 'Cancel';
            messageModal.classList.remove('hidden');
            messageModal.classList.add('flex');
            return new Promise(resolve => {
                currentModalResolver = resolve;
            });
        }

        /** Callback function for modal buttons. */
        window.modalCallback = function(result) {
            messageModal.classList.add('hidden');
            messageModal.classList.remove('flex');
            if (currentModalResolver) {
                currentModalResolver(result);
                currentModalResolver = null;
            }
        }

        /** Sets the loading state for the save button. */
        function setLoading(isLoading) {
            saveBtn.disabled = isLoading;
            if (isLoading) {
                buttonText.textContent = 'Saving...';
                loadingSpinner.classList.remove('hidden');
            } else {
                buttonText.textContent = 'Save Influencer';
                loadingSpinner.classList.add('hidden');
            }
        }

        /** Toggles the 'Other' channel type input visibility and requirement. */
        window.handleOtherType = function() {
            const isOther = channelTypeSelect.value === 'Other';
            if (isOther) {
                otherChannelTypeInput.classList.remove('hidden');
                otherChannelTypeInput.required = true;
                otherChannelTypeInput.disabled = false;
            } else {
                otherChannelTypeInput.classList.add('hidden');
                otherChannelTypeInput.required = false;
                otherChannelTypeInput.disabled = true;
                otherChannelTypeInput.value = ''; // Clear input when hidden
            }
        }

        /** Populates the country dropdown and sets the initial currency symbol. */
        function populateCountryDropdown() {
            // Include a comprehensive list of all countries (simulated for simplicity)
            const allCountries = [
                ...COUNTRIES_AND_CURRENCIES,
                { code: "AFG", country: "Afghanistan", currency: "AFN", symbol: "ÿã" },
                { code: "ARG", country: "Argentina", currency: "ARS", symbol: "$" },
                { code: "NGA", country: "Nigeria", currency: "NGN", symbol: "‚Ç¶" },
                { code: "SWE", country: "Sweden", currency: "SEK", symbol: "kr" },
                { code: "PAK", country: "Pakistan", currency: "PKR", symbol: "‚Ç®" },
                // ... more countries would be listed here in a complete app
            ];

            // Add all unique countries to the dropdown
            countrySelect.innerHTML = '<option value="" disabled selected>Select a country</option>';
            countrySelect.innerHTML += allCountries.map(item => 
                `<option value="${item.code}" data-currency="${item.currency || DEFAULT_CURRENCY_CODE}" data-symbol="${item.symbol || DEFAULT_CURRENCY_SYMBOL}">${item.country}</option>`
            ).join('');
            
            // Set default symbol
            currencySymbolSpan.textContent = DEFAULT_CURRENCY_SYMBOL;
        }

        /** Updates the currency symbol based on the selected country, using USD as fallback. */
        window.updateCurrencySymbol = function() {
            const selectedOption = countrySelect.options[countrySelect.selectedIndex];
            const countryCode = selectedOption?.value;
            
            const currencyData = COUNTRIES_AND_CURRENCIES.find(c => c.code === countryCode);
            
            let symbol = DEFAULT_CURRENCY_SYMBOL;
            let currency = DEFAULT_CURRENCY_CODE;

            if (currencyData) {
                symbol = currencyData.symbol;
                currency = currencyData.currency;
            } 
            // If country isn't in our defined list, it defaults to USD ($).
            
            currencySymbolSpan.textContent = symbol;
        }
        
        // Attach listener for currency update
        countrySelect.addEventListener('change', updateCurrencySymbol);


        // --- Firebase Initialization and Auth ---

        async function initializeFirebase() {
            try {
                // Initialize Firebase App
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Debug'); // Enable Firestore logging

                // 1. Initial Sign-In attempt
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 2. Set up Auth State Listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        authStatus.textContent = `User ID: ${userId}`;
                        authStatus.classList.replace('bg-emerald-700', 'bg-green-700');
                        loadInfluencers(); // Start listening for data once authenticated
                    } else {
                        userId = null;
                        isAuthReady = true;
                        authStatus.textContent = `Signed in Anonymously (No Persistence)`;
                        authStatus.classList.replace('bg-emerald-700', 'bg-red-700');
                        loadInfluencers(); // Still try to load data if permissions allow
                    }
                });

            } catch (e) {
                console.error("Firebase initialization failed:", e);
                showModal("Error", `Failed to initialize Firebase: ${e.message}`);
                authStatus.textContent = `Error: Initialization Failed`;
                authStatus.classList.replace('bg-emerald-700', 'bg-red-700');
            }
        }

        // --- Firestore Operations ---

        /** Gets the Firestore collection path for the user's private data. */
        function getCollectionRef() {
            if (!db || !userId) {
                console.error("Database or User ID not ready.");
                return null;
            }
            // Private user data collection path
            return collection(db, `artifacts/${appId}/users/${userId}/influencers`);
        }

        /** Saves a new influencer to Firestore. */
        async function saveInfluencer(event) {
            event.preventDefault();
            
            if (!isAuthReady || !userId) {
                showModal("Authentication Required", "Please wait for authentication to complete before saving data.");
                return;
            }

            setLoading(true);

            // Determine the final channel type
            let finalChannelType = channelTypeSelect.value;
            if (finalChannelType === 'Other') {
                finalChannelType = otherChannelTypeInput.value.trim() || 'Unspecified';
            }

            // Get selected country details and currency (using fallback logic)
            const selectedOption = countrySelect.options[countrySelect.selectedIndex];
            const countryName = selectedOption.textContent; 
            const countryCode = selectedOption.value;
            
            const currencyData = COUNTRIES_AND_CURRENCIES.find(c => c.code === countryCode);
            const finalCurrency = currencyData ? currencyData.currency : DEFAULT_CURRENCY_CODE;
            
            const minChargeValue = parseFloat(minChargeInput.value);

            const influencerData = {
                channelName: channelNameInput.value.trim(),
                type: finalChannelType,
                followers: followersInput.value.trim(), // Now a free text field
                country: countryName,
                currency: finalCurrency,
                minCharge: isNaN(minChargeValue) ? null : minChargeValue,
                phoneNumber: phoneNumberInput.value.trim() || null,
                timestamp: new Date().toISOString() 
            };

            try {
                await addDoc(getCollectionRef(), influencerData);
                showModal("Success", `Data for "${influencerData.channelName}" has been successfully saved.`);
                influencerForm.reset();
                window.handleOtherType(); // Hide custom input on reset
                updateCurrencySymbol(); // Reset currency symbol display
            } catch (error) {
                console.error("Error adding document: ", error);
                showModal("Save Error", `There was an error saving the influencer data: ${error.message}`);
            } finally {
                setLoading(false);
            }
        }

        /** Deletes an influencer document by ID. */
        window.deleteInfluencer = async function(docId, channelName) {
            if (!isAuthReady || !userId) {
                showModal("Authentication Error", "Cannot delete. Authentication is not ready.");
                return;
            }

            const confirmDelete = await showConfirm(
                "Confirm Deletion",
                `Are you sure you want to delete the record for "${channelName}"? This action cannot be undone.`
            );

            if (!confirmDelete) return;

            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/influencers`, docId);
                await deleteDoc(docRef);
                showModal("Deleted", `Record for "${channelName}" has been successfully removed.`);
            } catch (error) {
                console.error("Error deleting document: ", error);
                showModal("Deletion Error", `Failed to delete record: ${error.message}`);
            }
        }

        /** Loads influencers in real-time using onSnapshot. */
        function loadInfluencers() {
            if (!isAuthReady || !userId) return;

            const q = query(getCollectionRef()); 

            // Set initial status
            tableStatus.textContent = "Fetching data...";

            onSnapshot(q, (snapshot) => {
                const influencers = [];
                snapshot.forEach((doc) => {
                    influencers.push({ id: doc.id, ...doc.data() });
                });
                
                renderInfluencers(influencers);
            }, (error) => {
                console.error("Error listening to documents: ", error);
                tableStatus.textContent = "Error loading data.";
                showModal("Load Error", `Could not load real-time data: ${error.message}`);
            });
        }

        /** Renders the list of influencers into the table. */
        function renderInfluencers(influencers) {
            influencersTableBody.innerHTML = '';

            if (influencers.length === 0) {
                influencersTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-3 py-6 text-center text-sm text-gray-500 italic">
                            ${isAuthReady ? 'No influencers collected yet. Add one using the form.' : 'Waiting for authentication...'}
                        </td>
                    </tr>
                `;
                tableStatus.textContent = "Ready";
                return;
            }

            influencers.forEach(inf => {
                // Find the correct symbol, default to USD if not found in COUNTRIES_AND_CURRENCIES
                const symbol = COUNTRIES_AND_CURRENCIES.find(c => c.currency === inf.currency)?.symbol || DEFAULT_CURRENCY_SYMBOL;

                const chargeDisplay = inf.minCharge !== null 
                    ? `${symbol}${inf.minCharge.toLocaleString()}`
                    : 'N/A';

                const phoneDisplay = inf.phoneNumber || 'N/A';
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-emerald-50 transition duration-100';
                row.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">
                        <div class="font-semibold">${inf.channelName}</div>
                        <div class="text-xs text-gray-500">${inf.country}</div>
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-700">
                        <div class="text-xs font-semibold px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-800 w-fit mb-1">${inf.type}</div>
                        <div class="text-xs text-gray-600">${inf.followers}</div>
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-800 font-medium">
                        ${chargeDisplay} <span class="text-xs text-gray-500 ml-1">${inf.currency || ''}</span>
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-700">
                        ${phoneDisplay}
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="deleteInfluencer('${inf.id}', '${inf.channelName.replace(/'/g, "\\'")}')" 
                                class="text-red-600 hover:text-red-900 transition duration-150 p-1 rounded-md hover:bg-red-100">
                            Delete
                        </button>
                    </td>
                `;
                influencersTableBody.appendChild(row);
            });
            tableStatus.textContent = `Total Records: ${influencers.length}`;
        }

        // --- Event Listeners and Initial Load ---
        window.onload = () => {
            populateCountryDropdown();
            initializeFirebase();
        };

        influencerForm.addEventListener('submit', saveInfluencer);

    </script>
</body>
</html>

